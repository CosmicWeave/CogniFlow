import{P as ue,d as he,u as fe,a as pe,i as ve,r as c,x as Y,H as ge,e as Z,j as e,B as d,S as be,I as l,L as je,s as Ne,K as we}from"./index-BCY9tn3S.js";import{D as ke}from"./DeckListItem-23PzCa10.js";import{T as ye}from"./TruncatedText-CkR9_Paq.js";import"./MasteryBar-DeT_xrwj.js";const F=({icon:m,label:t,value:S,subtext:u,color:g="primary"})=>e.jsxs("div",{className:"bg-surface p-4 rounded-lg shadow-sm border border-border flex items-center gap-4",children:[e.jsx("div",{className:`p-3 rounded-full bg-${g}/10 text-${g}`,children:e.jsx(l,{name:m,className:"w-6 h-6"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-text-muted",children:t}),e.jsx("p",{className:"text-xl sm:text-2xl font-bold text-text",children:S}),u&&e.jsx("p",{className:"text-xs text-text-muted mt-0.5",children:u})]})]}),Ie=m=>{var W;const{series:t,sessionsToResume:S,onUpdateLastOpened:u,onUpdateDeck:g,onDeleteDeck:_,openConfirmModal:O,handleGenerateQuestionsForDeck:ee,handleGenerateContentForLearningDeck:se,onUpdateSeries:h}=m,f=ue(),{seriesProgress:U,aiGenerationStatus:te}=he(),{aiFeaturesEnabled:b}=fe(),{addToast:L}=pe(),ae=ve(),[j,I]=c.useState(!1),[E,N]=c.useState(t.name),[P,w]=c.useState(t.description),[Q,B]=c.useState(!1),[k,x]=c.useState(!1),M=c.useRef(null),[T,y]=c.useState(null),[z,H]=c.useState(""),D=c.useRef(null);c.useEffect(()=>{u(t.id)},[t.id,u]),c.useEffect(()=>{j||(N(t.name),w(t.description))},[t,j]),c.useEffect(()=>{T!==null&&D.current&&(D.current.focus(),D.current.select())},[T]),c.useEffect(()=>{const a=s=>{M.current&&!M.current.contains(s.target)&&x(!1)};return k&&document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[k]);const re=()=>{E.trim()&&(h({...t,name:E,description:P},{toastMessage:"Series updated."}),I(!1))},le=()=>{N(t.name),w(t.description),I(!1)},ne=async()=>{const a=(t.levels||[]).flatMap(s=>(s==null?void 0:s.deckIds)||[]).map(s=>f.find(r=>r.id===s)).filter(Boolean);if(a.length===0){L("Add some decks to this series first so the AI has context.","info");return}B(!0);try{const s=a.map(o=>`${o==null?void 0:o.name}: ${Ne(o==null?void 0:o.description)}`).join(`
`),{name:r,description:n}=await we(s,"series");N(r),w(n),L("Details generated!","success")}catch{L("Failed to generate details.","error")}finally{B(!1)}},A=(a,s)=>{y(a),H(s)},J=a=>{if(z.trim()){const s=[...t.levels||[]];s[a]={...s[a],title:z.trim()},h({...t,levels:s},{toastMessage:"Level renamed."})}y(null)},ie=()=>{const a={title:`Level ${(t.levels||[]).length+1}: New Level`,deckIds:[]},s=[...t.levels||[],a];h({...t,levels:s},{toastMessage:"New level added."}),setTimeout(()=>{A(s.length-1,a.title),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})},100)},oe=a=>{const s=t.levels[a],r=s.deckIds&&s.deckIds.length>0,n=()=>{const o=[...t.levels];o.splice(a,1),h({...t,levels:o},{toastMessage:"Level deleted."})};r?O({title:"Delete Level",message:`Are you sure you want to delete "${s.title}"? The ${s.deckIds.length} deck(s) inside will remain in your library but will be removed from this series.`,onConfirm:n}):n()},K=(a,s)=>{if(s==="up"&&a===0||s==="down"&&a===t.levels.length-1)return;const r=[...t.levels],n=s==="up"?a-1:a+1;[r[a],r[n]]=[r[n],r[a]],h({...t,levels:r})},V=(a,s)=>{const r=[...t.levels],n=r[a];r[a]={...n,deckIds:n.deckIds.filter(o=>o!==s)},h({...t,levels:r},{toastMessage:"Deck removed from series."})},{dueCount:R,nextUpDeckId:v,isCompleted:C,completedCount:G,totalCount:$}=Y.useMemo(()=>{const a=(t.levels||[]).flatMap(i=>(i==null?void 0:i.deckIds)||[]).map(i=>f.find(p=>p.id===i)).filter(i=>!!i),s=U.get(t.id)||new Set,r=s.size,n=(t.levels||[]).flatMap(i=>(i==null?void 0:i.deckIds)||[]),o=n.length,X=new Set;n.forEach((i,p)=>{p<=r&&X.add(i)});const ce=a.reduce((i,p)=>X.has(p.id)?i+ge(p):i,0),me=n.find(i=>!s.has(i))||null,xe=o>0&&r>=o;return{dueCount:ce,nextUpDeckId:me,isCompleted:xe,completedCount:r,totalCount:o}},[t,f,U]),de=Y.useMemo(()=>{const a=new Set((t.levels||[]).flatMap(r=>(r==null?void 0:r.deckIds)||[]));return f.filter(r=>a.has(r.id)).some(r=>{var n;return(r.type===Z.Quiz||r.type===Z.Learning)&&(((n=r.questions)==null?void 0:n.length)||0)===0})},[t.levels,f]),q=((W=te.currentTask)==null?void 0:W.seriesId)===t.id;return e.jsxs("div",{className:"max-w-5xl mx-auto animate-fade-in space-y-6 pb-20",children:[e.jsx("div",{className:`bg-surface rounded-xl shadow-sm border border-border ${j?"overflow-hidden":""}`,children:j?e.jsxs("div",{className:"p-6 space-y-4 animate-fade-in bg-background/50",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold text-text",children:"Edit Series Details"}),b&&e.jsxs(d,{variant:"ghost",size:"sm",onClick:ne,disabled:Q,className:"text-primary hover:text-primary-hover",children:[Q?e.jsx(be,{size:"sm"}):e.jsx(l,{name:"bot",className:"w-4 h-4 mr-2"}),"Auto-generate with AI"]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"series-name-edit",className:"block text-sm font-medium text-text-muted mb-1",children:"Series Name"}),e.jsx("input",{id:"series-name-edit",type:"text",value:E,onChange:a=>N(a.target.value),className:"w-full p-2 bg-background border border-border rounded-md focus:ring-2 focus:ring-primary focus:outline-none text-xl font-bold",autoFocus:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"series-desc-edit",className:"block text-sm font-medium text-text-muted mb-1",children:"Description"}),e.jsx("textarea",{id:"series-desc-edit",value:P,onChange:a=>w(a.target.value),rows:3,className:"w-full p-2 bg-background border border-border rounded-md focus:ring-2 focus:ring-primary focus:outline-none"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t border-border mt-4",children:[e.jsx(d,{variant:"secondary",onClick:le,children:"Cancel"}),e.jsxs(d,{onClick:re,children:[e.jsx(l,{name:"save",className:"mr-2"})," Save Changes"]})]})]}):e.jsxs("div",{className:"p-6 md:p-8 flex items-start justify-between gap-4 relative",children:[e.jsx("div",{className:"flex-1 min-w-0 pr-10 md:pr-0",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-3 bg-primary/10 rounded-xl flex-shrink-0 hidden sm:block",children:e.jsx(l,{name:"layers",className:"w-8 h-8 text-primary"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"flex items-center text-xs font-semibold text-text-muted mb-1 uppercase tracking-wider",children:e.jsx("span",{children:"Learning Series"})}),e.jsx("h1",{className:"text-2xl sm:text-3xl font-extrabold text-text break-words leading-tight",children:t.name}),t.description&&e.jsx("div",{className:"mt-2 text-text-muted",children:e.jsx(ye,{html:t.description,className:"prose prose-sm dark:prose-invert max-w-none text-text-muted leading-relaxed"})})]})]})}),e.jsxs("div",{className:"absolute top-6 right-6 md:static md:flex-shrink-0 md:self-start",ref:M,children:[e.jsx(d,{variant:"ghost",onClick:()=>x(!k),className:"p-2 rounded-full hover:bg-border/50",children:e.jsx(l,{name:"more-vertical",className:"w-6 h-6 text-text-muted"})}),k&&e.jsxs("div",{className:"absolute right-0 mt-2 w-56 bg-surface rounded-lg shadow-xl border border-border z-30 py-1 animate-fade-in origin-top-right",children:[e.jsxs("button",{onClick:()=>{I(!0),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors",children:[e.jsx(l,{name:"edit",className:"w-4 h-4 mr-3"})," Edit Details"]}),b&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{m.onAutoExpandSeries(t.id),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors",children:[e.jsx(l,{name:"layers",className:"w-4 h-4 mr-3"})," Auto-Expand Series"]}),e.jsxs("button",{onClick:()=>{m.onAiAddLevelsToSeries(t.id),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors",children:[e.jsx(l,{name:"plus",className:"w-4 h-4 mr-3"})," Generate Next Level"]})]}),b&&de&&e.jsxs("button",{onClick:()=>{m.handleGenerateQuestionsForEmptyDecksInSeries(t.id),x(!1)},disabled:q,className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors disabled:opacity-50",children:[e.jsx(l,{name:"zap",className:"w-4 h-4 mr-3"})," ",q?"Generating...":"Generate All Questions"]}),e.jsxs("button",{onClick:()=>{ae.handleViewSeriesJson(t),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors",children:[e.jsx(l,{name:"code",className:"w-4 h-4 mr-3"})," View JSON"]}),e.jsxs("button",{onClick:()=>{m.onExportSeries(t),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-text hover:bg-primary/5 hover:text-primary transition-colors",children:[e.jsx(l,{name:"download",className:"w-4 h-4 mr-3"})," Export JSON"]}),e.jsx("div",{className:"my-1 border-t border-border"}),e.jsxs("button",{onClick:()=>{m.onDeleteSeries(t.id),x(!1)},className:"flex items-center w-full px-4 py-2.5 text-sm text-left text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors",children:[e.jsx(l,{name:"trash-2",className:"w-4 h-4 mr-3"})," Move to Trash"]})]})]})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 items-center justify-between p-6 bg-primary/5 rounded-xl border border-primary/10",children:[e.jsxs("div",{className:"flex-1 text-center md:text-left",children:[e.jsx("h3",{className:"text-lg font-bold text-text mb-1",children:C?"Series Completed!":v?"Ready to continue learning?":"Start this series."}),e.jsx("p",{className:"text-sm text-text-muted",children:C?"Great job! Review due items to maintain mastery.":v?"Pick up where you left off.":"Begin the first level."})]}),e.jsxs("div",{className:"flex flex-wrap gap-3 justify-center md:justify-end w-full md:w-auto",children:[!C&&v&&e.jsxs(je,{href:`/decks/${v}/study?seriesId=${t.id}`,passAs:d,variant:"primary",size:"lg",className:"font-bold px-8 shadow-md flex-1 md:flex-none",children:[e.jsx(l,{name:"zap",className:"w-5 h-5 mr-2"}),G>0?"Continue":"Start Series"]}),R>0&&e.jsxs(d,{variant:!C&&v?"secondary":"primary",size:"lg",onClick:()=>m.onStartSeriesStudy(t.id),className:"font-bold flex-1 md:flex-none",children:[e.jsx(l,{name:"refresh-ccw",className:"w-5 h-5 mr-2"}),"Study Due (",R,")"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsx(F,{icon:"layers",label:"Total Decks",value:$,color:"blue"}),e.jsx(F,{icon:"check-circle",label:"Progress",value:`${G}/${$}`,subtext:`${Math.round(G/($||1)*100)}% Complete`,color:"green"}),e.jsx(F,{icon:"zap",label:"Due Today",value:R,color:"orange"})]}),e.jsx("div",{className:"space-y-6 sm:space-y-8 mt-4 sm:mt-8",children:(t.levels||[]).map((a,s)=>e.jsxs("div",{className:"bg-surface rounded-xl p-4 border border-border shadow-sm",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-border pb-2 gap-2",children:[T===s?e.jsxs("div",{className:"flex-grow flex items-center gap-2 w-full sm:w-auto",children:[e.jsx("input",{ref:D,type:"text",value:z,onChange:r=>H(r.target.value),onKeyDown:r=>{r.key==="Enter"&&J(s),r.key==="Escape"&&y(null)},className:"flex-grow p-1 bg-background border border-border rounded focus:ring-2 focus:ring-primary focus:outline-none font-semibold text-lg"}),e.jsx(d,{size:"sm",variant:"primary",onClick:()=>J(s),children:e.jsx(l,{name:"check-circle",className:"w-4 h-4"})}),e.jsx(d,{size:"sm",variant:"ghost",onClick:()=>y(null),children:e.jsx(l,{name:"x",className:"w-4 h-4"})})]}):e.jsx("h3",{className:"text-xl font-bold text-text flex-grow cursor-pointer hover:text-primary transition-colors",onClick:()=>A(s,a.title),children:a.title}),e.jsxs("div",{className:"flex items-center gap-1 self-end sm:self-auto",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"p-1 h-auto text-text-muted hover:text-text",onClick:()=>K(s,"up"),disabled:s===0,title:"Move Up",children:e.jsx(l,{name:"chevron-down",className:"w-4 h-4 rotate-180"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"p-1 h-auto text-text-muted hover:text-text",onClick:()=>K(s,"down"),disabled:s===(t.levels||[]).length-1,title:"Move Down",children:e.jsx(l,{name:"chevron-down",className:"w-4 h-4"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"p-1 h-auto text-text-muted hover:text-text",onClick:()=>A(s,a.title),title:"Rename Level",children:e.jsx(l,{name:"edit",className:"w-4 h-4"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"p-1 h-auto text-text-muted hover:text-red-500",onClick:()=>oe(s),title:"Delete Level",children:e.jsx(l,{name:"trash-2",className:"w-4 h-4"})}),b&&e.jsxs("div",{className:"flex gap-1 ml-2 border-l border-border pl-2",children:[e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>m.onAiAddDecksToLevel(t.id,s),title:"AI: Add Empty Decks",children:e.jsx(l,{name:"plus",className:"w-4 h-4"})}),e.jsx(d,{variant:"ghost",size:"sm",onClick:()=>m.onGenerateDeckForLevel(t.id,s),title:"AI: Generate Deck",children:e.jsx(l,{name:"zap",className:"w-4 h-4"})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[a.deckIds.map(r=>{const n=f.find(o=>o.id===r);return n?e.jsx(ke,{deck:n,sessionsToResume:S,onUpdateLastOpened:()=>u(t.id),draggedDeckId:null,onDragStart:()=>{},onDragEnd:()=>{},onUpdateDeck:g,onDeleteDeck:_,openConfirmModal:O,handleGenerateQuestionsForDeck:ee,handleGenerateContentForLearningDeck:se,onRemoveFromSeries:()=>V(s,n.id)},n.id):e.jsxs("div",{className:"p-4 bg-red-100 text-red-800 rounded-md flex justify-between items-center",children:[e.jsxs("span",{children:['Deck with ID "',r,'" not found.']}),e.jsx(d,{size:"sm",variant:"ghost",className:"text-red-800 hover:bg-red-200",onClick:()=>V(s,r),children:"Remove"})]},r)}),(a.deckIds||[]).length===0&&e.jsxs("div",{className:"text-center p-8 border-2 border-dashed border-border rounded-lg text-text-muted text-sm",children:[e.jsx(l,{name:"folder",className:"w-8 h-8 mx-auto mb-2 opacity-50"}),"No decks in this level yet."]})]})]},s))}),e.jsx("div",{className:"flex justify-center pt-8 border-t border-border",children:e.jsxs(d,{onClick:ie,variant:"secondary",className:"w-full sm:w-auto",children:[e.jsx(l,{name:"plus",className:"w-5 h-5 mr-2"}),"Add New Level"]})})]})};export{Ie as default};
